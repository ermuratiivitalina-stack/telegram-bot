import os
import asyncio

from aiogram import Bot, Dispatcher, F
from aiogram.filters import Command
from aiogram.types import (
    Message,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    ChatJoinRequest,
)

# â”€â”€ env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN is not set in environment variables")

# Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ¹Ğ´Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² (ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑˆÑŒ)
RU_CHAT_ID = int(os.getenv("RU_CHAT_ID", "0"))
ES_CHAT_ID = int(os.getenv("ES_CHAT_ID", "0"))

bot = Bot(BOT_TOKEN)
dp = Dispatcher()


# â”€â”€ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def kb_lang() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² ĞºĞ°Ğ½Ğ°Ğ» ğŸ‡·ğŸ‡º", callback_data="join_ru")],
            [InlineKeyboardButton(text="Entrar al canal ğŸ‡ªğŸ‡¸", callback_data="join_es")],
        ]
    )


# â”€â”€ handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message(Command("start"))
async def start(m: Message):
    await m.answer(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»/ÑĞ·Ñ‹Ğº ğŸ‘‡\nÂ¡Hola! Elige tu canal/idioma ğŸ‘‡",
        reply_markup=kb_lang(),
    )


@dp.callback_query(F.data == "join_ru")
async def join_ru(cq):
    # ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ²Ğ¾ Ğ²ÑĞ¿Ğ»Ñ‹Ğ²Ğ°ÑÑ‰ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¸
    await cq.answer("ĞŸĞ¾Ğ´Ğ°Ñ‡Ğ° Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ°, Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸.", show_alert=False)
    # ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ñ‡Ğ°Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° (ĞµÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ)
    await cq.message.answer("ĞŸĞ¾Ğ´Ğ°Ğ¹ Ğ·Ğ°ÑĞ²ĞºÑƒ Ğ½Ğ° Ğ²ÑÑ‚ÑƒĞ¿Ğ»ĞµĞ½Ğ¸Ğµ Ğ² RU-ĞºĞ°Ğ½Ğ°Ğ» â€” Ğ±Ğ¾Ñ‚ Ğ¾Ğ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸.")


@dp.callback_query(F.data == "join_es")
async def join_es(cq):
    await cq.answer("Solicitud enviada, espera la verificaciÃ³n.", show_alert=False)
    await cq.message.answer("Envia solicitud al canal ES â€” el bot aprobarÃ¡ tras la verificaciÃ³n.")


# Ğ°Ğ²Ñ‚Ğ¾Ğ°Ğ¿Ñ€ÑƒĞ² Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ½Ğ° Ğ²ÑÑ‚ÑƒĞ¿Ğ»ĞµĞ½Ğ¸Ğµ (Ğ±Ğ¾Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ğ°)
@dp.chat_join_request()
async def on_join(r: ChatJoinRequest):
    try:
        await r.approve()
        await bot.send_message(
            r.from_user.id,
            "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½ âœ…\nĞ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!"
        )
    except Exception as e:
        print("join error:", e)


# â”€â”€ entrypoint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    # Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ keep-alive HTTP, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Render Ğ½Ğµ â€œÑƒÑÑ‹Ğ¿Ğ»ÑĞ»â€ ÑĞµÑ€Ğ²Ğ¸Ñ
    import threading
    from http.server import BaseHTTPRequestHandler, HTTPServer

    class _HealthHandler(BaseHTTPRequestHandler):
        def do_GET(self):
            if self.path == "/health":
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.end_headers()
                self.wfile.write(b"OK")
            else:
                self.send_response(404)
                self.end_headers()
await bot.delete_webhook(drop_pending_updates=True)

    def _run_health_server():
        port = int(os.getenv("PORT", "10000"))
        server = HTTPServer(("0.0.0.0", port), _HealthHandler)
        server.serve_forever()

    threading.Thread(target=_run_health_server, daemon=True).start()

   async def main():
    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ webhook, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° Ñ polling
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

