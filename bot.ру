import os
import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.filters import CommandStart
from aiogram.types import (
    Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile
)
from aiogram.enums import ContentType
from datetime import datetime, timedelta
import pytesseract
from PIL import Image

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN not set")

bot = Bot(BOT_TOKEN)
dp = Dispatcher()

# In-memory user data (for demo only, replace with DB or JSON in real case)
user_data = {}
CHANNEL_LINKS = {
    "ru": "https://t.me/+bePV7UZ8zdwxOWU0",
    "es": "https://t.me/+HPXk4hRDxpMwYWQ0"
}
PAYPAL_URL = "https://paypal.me/yourlink"
ADMIN_USERNAME = "Linavibeart"

# Language options
def language_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–†—É—Å—Å–∫–∏–π", callback_data="lang_ru")],
        [InlineKeyboardButton(text="Espa√±ol", callback_data="lang_es")]
    ])

# Start command
dp.message(CommandStart())
async def start(message: Message):
    await message.answer("Please choose your language / Por favor, elige el idioma", reply_markup=language_keyboard())

# Welcome keyboards
def main_menu(lang):
    text_pay = "üí≥ Pay" if lang == "en" else "–û–ø–ª–∞—Ç–∏—Ç—å"
    text_more = "‚ÑπÔ∏è Learn More" if lang == "en" else "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ"
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=text_pay, callback_data="pay")],
        [InlineKeyboardButton(text=text_more, callback_data="more")]
    ])

# After video keyboard
def after_video_keyboard(lang):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí≥ Pay", callback_data="pay")],
        [InlineKeyboardButton(text="‚ùì Have questions?", url=f"https://t.me/{ADMIN_USERNAME}")]
    ])

# Language selection
dp.callback_query(F.data.startswith("lang_"))
async def set_language(callback: CallbackQuery):
    lang = callback.data.split("_")[1]
    user_data[callback.from_user.id] = {
        "lang": lang,
        "subscribed": False,
        "subscription_expires": None
    }
    greeting = {
        "ru": "üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –õ–∏–Ω—ã üòä\n–†–∞–¥, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –≥–¥–µ —É—á–∞—Ç—Å—è —Å–Ω–∏–º–∞—Ç—å –≤–∏–¥–µ–æ –∏ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ —Ü–µ–ø–ª—è—é—Ç üé•‚ú®\n\n–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –∂–¥—ë—Ç:\n‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–∏–¥–µ–æ\n‚úÖ –ö—Ä—É–ø–Ω—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Å—ä—ë–º–∫–µ –∏ —Å–≤–µ—Ç—É\n‚úÖ –ú–∏–Ω–∏-—É—Ä–æ–∫–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ ¬´–ø–ª—é—à–∫–∏¬ª\n‚úÖ –†–∞–∑–±–æ—Ä—ã –≤–∏–¥–µ–æ —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö\n\nüí∞ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –≤—Å–µ–≥–æ 15 –µ–≤—Ä–æ –≤ –º–µ—Å—è—Ü\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª —Å —É—Ä–æ–∫–∞–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ üîí\n\nüöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ö–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ üëá",
        "es": "üëã ¬°Hola! Soy el asistente de Lina. Accede al canal privado con contenido exclusivo. ¬°Haz clic en los botones abajo!"
    }.get(lang, "üëã Welcome! Click the buttons below to continue.")
    await callback.message.answer(greeting, reply_markup=main_menu("en" if lang == "es" else "ru"))
    await callback.answer()

# Learn more (video)
dp.callback_query(F.data == "more")
async def send_video(callback: CallbackQuery):
    lang = user_data.get(callback.from_user.id, {}).get("lang", "en")
    video = FSInputFile("video.mp4")  # must be present in project directory
    caption = {
        "ru": "üé• –ü—Ä–æ—Å–º–æ—Ç—Ä–∏ –ø—Ä–µ–≤—å—é –Ω–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞.",
        "es": "üé• Mira una vista previa del canal."
    }.get(lang, "üé• Watch a preview of our channel.")
    await callback.message.answer_video(video=video, caption=caption, reply_markup=after_video_keyboard(lang))
    await callback.answer()

# Pay button
dp.callback_query(F.data == "pay")
async def pay_step(callback: CallbackQuery):
    await callback.message.answer(f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ–ø–ª–∞—Ç—ã —Å—é–¥–∞.\n–ò–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π: {PAYPAL_URL}")
    await callback.answer()

# OCR check payment screenshot
dp.message(F.photo)
async def check_payment_screenshot(message: Message):
    user_id = message.from_user.id
    lang = user_data.get(user_id, {}).get("lang", "ru")

    file = await bot.get_file(message.photo[-1].file_id)
    filepath = file.file_path
    saved_path = f"screenshot_{user_id}.jpg"
    await bot.download_file(filepath, saved_path)

    # OCR scan
    text = pytesseract.image_to_string(Image.open(saved_path))
    os.remove(saved_path)

    keywords = ["paypal", "15", "eur", "–µ–≤—Ä–æ", "—É—Å–ø–µ—à–Ω–æ", "–ø–ª–∞—Ç–µ–∂"]
    if any(k.lower() in text.lower() for k in keywords):
        user_data[user_id]["subscribed"] = True
        user_data[user_id]["subscription_expires"] = datetime.utcnow() + timedelta(days=30)
        await message.answer(f"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–ª–∞—Ç—É!\n–í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª: {CHANNEL_LINKS[lang]}")
    else:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç —á—ë—Ç–∫–∏–π –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª–∏ –æ–ø–ª–∞—Ç—ã.")

# Daily subscription check (to be called daily via scheduler)
async def check_subscriptions():
    now = datetime.utcnow()
    for user_id, info in user_data.items():
        if info["subscribed"] and info["subscription_expires"]:
            days_left = (info["subscription_expires"] - now).days
            if days_left == 3:
                try:
                    await bot.send_message(user_id, "‚è≥ –ù–∞–ø–æ–º–∏–Ω–∞–µ–º: —á–µ—Ä–µ–∑ 3 –¥–Ω—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å?")
                except:
                    pass

# Run bot
async def main():
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
