import os
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils import executor
from aiogram.dispatcher.filters import Text
from datetime import datetime, timedelta
import pytesseract
from PIL import Image

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("No BOT_TOKEN provided")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

CHANNEL_LINKS = {
    "ru": "https://t.me/+bePV7UZ8zdwxOWU0",
    "es": "https://t.me/+HPXk4hRDxpMwYWQ0"
}

user_data = {}

start_keyboard = InlineKeyboardMarkup().add(InlineKeyboardButton("Start", callback_data="start"))
lang_keyboard = InlineKeyboardMarkup(
    inline_keyboard=[
        [InlineKeyboardButton("–†—É—Å—Å–∫–∏–π üá∑üá∫", callback_data="lang_ru")],
        [InlineKeyboardButton("Espa√±ol üá™üá∏", callback_data="lang_es")]
    ]
)

faq_text = """üí¨ –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã
üìÖ 1. –°–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É?
–ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 –º–µ—Å—è—Ü, –ø–æ—Å–ª–µ —á–µ–≥–æ –µ—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–¥–ª–∏—Ç—å.
üìò 2. –ï—Å—Ç—å –ª–∏ –≤ –∫–∞–Ω–∞–ª–µ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã?
–î–∞! –í –∫–∞–Ω–∞–ª–µ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –æ–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –∏ –Ω–æ–≤—ã–µ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é.
üí¨ 3. –ï—Å—Ç—å –ª–∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞?
–î–∞, –¥–≤–∞–∂–¥—ã –≤ –º–µ—Å—è—Ü –õ–∏–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –≥–¥–µ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã.
üîí 4. –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —è –Ω–µ –ø—Ä–æ–¥–ª—é –ø–æ–¥–ø–∏—Å–∫—É –≤–æ–≤—Ä–µ–º—è?
–ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –∫–∞–Ω–∞–ª–∞.
–í—ã —Å–º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø, –æ—Ñ–æ—Ä–º–∏–≤ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏.
üí≥ 5. –ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–ø–ª–∞—Ç–∞ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏?
–ü–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≤–∞—à–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (SMS –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram) –∏ —Å–º–æ–∂–µ—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.
üí∞ 6. –ú–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –º–Ω–µ –Ω–µ –ø–æ–¥–æ—à–ª–∞?
–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∏—Å—ã–≤–∞–ª–∞—Å—å —Å–ª–µ–¥—É—é—â–∞—è –æ–ø–ª–∞—Ç–∞.
üéì 7. –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–Ω–∞–ª –Ω–æ–≤–∏—á–∫–∞–º?
–î–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–∞ —Ä–∞–∑–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ ‚Äî –æ—Ç –Ω–æ–≤–∏—á–∫–æ–≤ –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö.
‚è∞ 8. –ú–æ–∂–Ω–æ –ª–∏ —Å–º–æ—Ç—Ä–µ—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è?
–î–∞, –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –∫–∞–Ω–∞–ª–µ, –∏ –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑—É—á–∞—Ç—å –∏—Ö –≤ —Å–≤–æ—ë–º —Ç–µ–º–ø–µ.
üÜò 9. –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —è –Ω–µ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã?
–ù–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É (—Å—Å—ã–ª–∫–∞ –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç). –ú—ã –ø—Ä–æ–≤–µ—Ä–∏–º –æ–ø–ª–∞—Ç—É –∏ –≤—Ä—É—á–Ω—É—é –æ—Ç–∫—Ä–æ–µ–º –¥–æ—Å—Ç—É–ø.
üë©‚Äçüè´ 10. –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–¥–∞—Ç—å –ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –õ–∏–Ω–µ?
–û—Å–Ω–æ–≤–Ω–∞—è —Å–≤—è–∑—å ‚Äî —á–µ—Ä–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è 2 —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü.
–ò–Ω–æ–≥–¥–∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –∂–∏–≤—ã–µ —ç—Ñ–∏—Ä—ã —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.
‚ùì –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?
–ñ–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"""

@dp.message_handler(commands=["start"])
async def cmd_start(message: types.Message):
    await message.answer("Choose language / Elige el idioma", reply_markup=lang_keyboard)

@dp.callback_query_handler(Text(startswith="lang_"))
async def set_language(callback: types.CallbackQuery):
    lang = callback.data.split("_")[1]
    user_id = callback.from_user.id
    user_data[user_id] = {"lang": lang}

    if lang == "ru":
        greeting = "üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –õ–∏–Ω—ã üòä\n–†–∞–¥, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –≥–¥–µ —É—á–∞—Ç—Å—è —Å–Ω–∏–º–∞—Ç—å –≤–∏–¥–µ–æ –∏ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ —Ü–µ–ø–ª—è—é—Ç üé•‚ú®\n–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –∂–¥—ë—Ç:\n‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–∏–¥–µ–æ\n‚úÖ –ö—Ä—É–ø–Ω—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Å—ä—ë–º–∫–µ –∏ —Å–≤–µ—Ç—É\n‚úÖ –ú–∏–Ω–∏-—É—Ä–æ–∫–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ ¬´–ø–ª—é—à–∫–∏¬ª\n‚úÖ –†–∞–∑–±–æ—Ä—ã –≤–∏–¥–µ–æ —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö\nüí∞ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –≤—Å–µ–≥–æ 15 –µ–≤—Ä–æ –≤ –º–µ—Å—è—Ü\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª —Å —É—Ä–æ–∫–∞–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ üîí\nüöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ö–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ üëá"
        buttons = [
            [InlineKeyboardButton("üé• –°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ", url="https://example.com/your-private-video.mp4")],
            [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal", url="https://www.paypal.com/qrcodes/p2pqrc/3MVJCABCAWXN6")],
            [InlineKeyboardButton("‚ùì –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?", callback_data="faq")]
        ]
    else:
        greeting = "üëã ¬°Hola! Soy el asistente de Lina üòä\nEst√°s muy cerca de unirte a una comunidad privada donde aprender√°s a crear videos y fotos impactantes üé•‚ú®\nContenido exclusivo:\n‚úÖ An√°lisis detallado de videos\n‚úÖ Proyectos reales\n‚úÖ Consejos pr√°cticos sobre iluminaci√≥n\n‚úÖ Mini-lecciones y bonus\nüí∞ Suscripci√≥n: solo 15 ‚Ç¨ al mes\nAccede al canal privado despu√©s del pago üîí\nüöÄ ¬øListo para empezar? Pulsa los botones üëá"
        buttons = [
            [InlineKeyboardButton("üé• Ver video", url="https://example.com/your-private-video.mp4")],
            [InlineKeyboardButton("üí≥ Pagar con PayPal", url="https://www.paypal.com/qrcodes/p2pqrc/3MVJCABCAWXN6")],
            [InlineKeyboardButton("‚ùì ¬øTienes preguntas?", callback_data="faq")]
        ]

    markup = InlineKeyboardMarkup(inline_keyboard=buttons)
    await callback.message.edit_text(greeting, reply_markup=markup)

@dp.callback_query_handler(Text(equals="faq"))
async def show_faq(callback: types.CallbackQuery):
    await callback.message.answer(faq_text)
    markup = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal", url="https://www.paypal.com/qrcodes/p2pqrc/3MVJCABCAWXN6")],
            [InlineKeyboardButton("üë§ –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url="https://t.me/Linavibeart")]
        ]
    )
    await callback.message.answer("üëá –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)

@dp.message_handler(content_types=types.ContentType.PHOTO)
async def check_payment(message: types.Message):
    user_id = message.from_user.id
    lang = user_data.get(user_id, {}).get("lang", "ru")
    file_id = message.photo[-1].file_id
    file = await bot.get_file(file_id)
    path = file.file_path
    saved_path = f"screenshot_{user_id}.jpg"
    await bot.download_file(path, saved_path)

    # OCR
    text = pytesseract.image_to_string(Image.open(saved_path))
    os.remove(saved_path)

    keywords = ["paypal", "15", "eur", "–µ–≤—Ä–æ", "—Å—É–º–º–∞", "–ø–ª–∞—Ç–µ–∂"]
    if any(k.lower() in text.lower() for k in keywords):
        await message.answer("‚úÖ –°–ø–∞—Å–∏–±–æ! –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.")
    else:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç —á—ë—Ç–∫–∏–π –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª–∏ –æ–ø–ª–∞—Ç—ã.")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ health-check
if __name__ == "__main__":
    import threading
    from http.server import BaseHTTPRequestHandler, HTTPServer

    class _HealthHandler(BaseHTTPRequestHandler):
        def do_GET(self):
            if self.path == "/health":
                self.send_response(200)
                self.send_header("Content-Type", "text/plain")
                self.end_headers()
                self.wfile.write(b"OK")
            else:
                self.send_response(404)
                self.end_headers()

    def _run_health_server():
        port = int(os.getenv("PORT", "8080"))
        server = HTTPServer(("0.0.0.0", port), _HealthHandler)
        server.serve_forever()

    threading.Thread(target=_run_health_server, daemon=True).start()

    executor.start_polling(dp, skip_updates=True)
