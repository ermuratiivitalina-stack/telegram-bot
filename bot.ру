import os
import asyncio

from aiogram import Bot, Dispatcher, F
from aiogram.filters import Command
from aiogram.types import (
    Message,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    ChatJoinRequest,
)

# --- env ---
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN is not set in environment variables")

RU_CHAT_ID = int(os.getenv("RU_CHAT_ID", "0"))
ES_CHAT_ID = int(os.getenv("ES_CHAT_ID", "0"))

bot = Bot(BOT_TOKEN)
dp = Dispatcher()


# --- –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ---
def kb_lang() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="–í–æ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª üá∑üá∫", callback_data="join_ru")],
            [InlineKeyboardButton(text="Entrar al canal üá™üá∏", callback_data="join_es")],
        ]
    )


# --- handlers ---
@dp.message(Command("start"))
async def start(m: Message):
    await m.answer(
        "–ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª/—è–∑—ã–∫ üëá\n¬°Hola! Elige tu canal/idioma üëá",
        reply_markup=kb_lang(),
    )


@dp.callback_query(F.data == "join_ru")
async def join_ru(cq):
    await cq.answer("–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –ø—Ä–∏–Ω—è—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.", show_alert=False)
    await cq.message.answer("–ü–æ–¥–∞–π –∑–∞—è–≤–∫—É –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ RU-–∫–∞–Ω–∞–ª ‚Äî –±–æ—Ç –æ–¥–æ–±—Ä–∏—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.")


@dp.callback_query(F.data == "join_es")
async def join_es(cq):
    await cq.answer("Solicitud enviada, espera la verificaci√≥n.", show_alert=False)
    await cq.message.answer("Env√≠a solicitud al canal ES ‚Äî el bot aprobar√° tras la verificaci√≥n.")


@dp.chat_join_request()
async def on_join(r: ChatJoinRequest):
    try:
        await r.approve()
        await bot.send_message(
            r.from_user.id,
            "–î–æ—Å—Ç—É–ø –æ–¥–æ–±—Ä–µ–Ω ‚úÖ\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
        )
    except Exception as e:
        print("join error:", e)


# --- keep-alive –¥–ª—è Render ---
import threading
from http.server import BaseHTTPRequestHandler, HTTPServer

class _HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == "/health":
            self.send_response(200)
            self.send_header("Content-Type", "text/plain; charset=utf-8")
            self.end_headers()
            self.wfile.write(b"OK")
        else:
            self.send_response(404)
            self.end_headers()


def _run_health_server():
    port = int(os.getenv("PORT", "10000"))
    server = HTTPServer(("0.0.0.0", port), _HealthHandler)
    server.serve_forever()

threading.Thread(target=_run_health_server, daemon=True).start()


# --- –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
async def main():
    # –£–¥–∞–ª—è–µ–º webhook, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å polling
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
