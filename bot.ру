
import os
from typing import Dict
from aiogram import Bot, Dispatcher, executor
from aiogram.types import (
    InlineKeyboardMarkup, InlineKeyboardButton,
    CallbackQuery, Message, ContentType,
)

# ========= –ö–æ–Ω—Ñ–∏–≥ =========
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("Environment variable BOT_TOKEN is not set")

PAYPAL_URL = os.getenv("PAYPAL_URL", "https://www.paypal.com/qrcodes/p2pqr/3MVJCABCAVKN6")
SUPPORT_URL = os.getenv("SUPPORT_URL", "https://t.me/Linavibeart")
CHANNEL_LINKS: Dict[str, str] = {
    "ru": "https://t.me/+ebPVUZ8dzkwOWU8",
    "es": "https://t.me/+HPXk4hRDxpMWpWQ0",
}

# ========= –¢–µ–∫—Å—Ç—ã =========
FAQ_RU = (
    "üí¨ –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n"
    "1) ‚è≥ –°–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ—Å—Ç—É–ø? ‚Äî 1 –º–µ—Å—è—Ü.\n\n"
    "2) üìö –ï—Å—Ç—å –ª–∏ –≤ –∫–∞–Ω–∞–ª–µ —É–∂–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã? ‚Äî –î–∞, –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é.\n\n"
    "3) üõü –ï—Å—Ç—å –ª–∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å? ‚Äî –î–∞, 2 —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü –æ—Ç–∫—Ä—ã–≤–∞—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.\n\n"
    "4) üîí –ù–µ –ø—Ä–æ–¥–ª–∏–ª –≤–æ–≤—Ä–µ–º—è? ‚Äî –î–æ—Å—Ç—É–ø –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è.\n\n"
    "5) üí≥ –ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å/–ø—Ä–æ–¥–ª–∏—Ç—å? ‚Äî –ü—Ä–∏–¥—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø–µ—Ä–∏–æ–¥–∞.\n\n"
    "6) üí∏ –í–æ–∑–≤—Ä–∞—Ç? ‚Äî –ù–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω, –Ω–æ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ.\n\n"
    "7) üßë‚Äçüéì –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–Ω–∞–ª –Ω–æ–≤–∏—á–∫–∞–º? ‚Äî –î–∞, –æ—Ç –Ω–æ–≤–∏—á–∫–æ–≤ –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö.\n\n"
    "8) ‚è±Ô∏è –ú–æ–∂–Ω–æ –ª–∏ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è? ‚Äî –î–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –∫–∞–Ω–∞–ª–µ.\n\n"
    "9) ‚ùó–ù–µ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã? ‚Äî –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.\n\n"
    "‚ùì –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã? –ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ."
)
FAQ_ES = (
    "üí¨ Preguntas frecuentes\n\n"
    "1) ‚è≥ ¬øDuraci√≥n del acceso? ‚Äî 1 mes.\n\n"
    "2) üìö ¬øHay contenido ya? ‚Äî S√≠, se actualiza 3 veces por semana.\n\n"
    "3) üõü ¬øHay soporte? ‚Äî S√≠, abro comentarios 2 veces al mes.\n\n"
    "4) üîí Si no renuevo a tiempo, el acceso se pausa hasta renovar.\n\n"
    "5) üí≥ ¬øC√≥mo pagar/renovar? ‚Äî Recibir√°s un aviso antes de que termine el per√≠odo.\n\n"
    "6) üí∏ ¬øReembolso? ‚Äî No, pero puedes cancelar la renovaci√≥n.\n\n"
    "7) üßë‚Äçüéì ¬øPara principiantes? ‚Äî S√≠, para todos los niveles.\n\n"
    "8) ‚è±Ô∏è ¬øVer cuando quieras? ‚Äî S√≠, el contenido permanece en el canal.\n\n"
    "9) ‚ùó¬øSin acceso tras pagar? ‚Äî Escribe a soporte.\n\n"
    "‚ùì ¬øM√°s preguntas? Pulsa los botones abajo."
)

# ========= –°–æ—Å—Ç–æ—è–Ω–∏–µ =========
user_data: Dict[int, Dict] = {}
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

# ========= –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã =========
def lang_keyboard() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang:ru"))
    kb.add(InlineKeyboardButton("üá™üá∏ Espa√±ol", callback_data="lang:es"))
    return kb

def main_keyboard(lang: str) -> InlineKeyboardMarkup:
    text_watch = "‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ" if lang == "ru" else "‚ñ∂Ô∏è Ver video"
    text_pay = "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal" if lang == "ru" else "üí≥ Pagar con PayPal"
    text_faq = "‚ùì –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?" if lang == "ru" else "‚ùì ¬øTienes preguntas?"
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text_watch, url="https://example.com/your-private-video.mp4")],
        [InlineKeyboardButton(text_pay, url=PAYPAL_URL)],
        [InlineKeyboardButton(text_faq, callback_data="faq")],
    ])

def faq_keyboard(lang: str) -> InlineKeyboardMarkup:
    text_pay = "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal" if lang == "ru" else "üí≥ Pagar con PayPal"
    text_support = "üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞" if lang == "ru" else "üÜò Soporte"
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text_pay, url=PAYPAL_URL)],
        [InlineKeyboardButton(text_support, url=SUPPORT_URL)],
    ])

# ========= –•–µ–Ω–¥–ª–µ—Ä—ã =========
@dp.message_handler(commands=["start"])
async def cmd_start(message: Message):
    await message.answer("–í—ã–±–µ—Ä–∏ —è–∑—ã–∫ / Elige el idioma:", reply_markup=lang_keyboard())

@dp.callback_query_handler(lambda c: c.data and c.data.startswith("lang:"))
async def select_lang(callback: CallbackQuery):
    lang = callback.data.split(":", 1)[1]
    uid = callback.from_user.id
    user_data[uid] = user_data.get(uid, {})
    user_data[uid]["lang"] = lang

    if lang == "ru":
        greeting = (
            "üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –õ–∏–Ω—ã\n\n"
            "–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –∂–¥—ë—Ç:\n"
            "‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–∏–¥–µ–æ\n"
            "‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n"
            "‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Å—ä—ë–º–∫–µ –∏ —Å–≤–µ—Ç—É\n"
            "‚úÖ –ú–∏–Ω–∏-—É—Ä–æ–∫–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ ¬´–ø–ª—é—à–∫–∏¬ª\n"
            "üí∂ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –≤—Å–µ–≥–æ 15 –µ–≤—Ä–æ –≤ –º–µ—Å—è—Ü\n"
            "üì¶ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª —Å —É—Ä–æ–∫–∞–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏\n\n"
            "üöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ö–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ ‚¨áÔ∏è"
        )
    else:
        greeting = (
            "üëã ¬°Hola! Soy el asistente de Lina\n\n"
            "Dentro te espera:\n"
            "‚úÖ Contenido exclusivo\n"
            "‚úÖ An√°lisis detallado de videos\n"
            "‚úÖ Proyectos reales\n"
            "‚úÖ Consejos pr√°cticos sobre iluminaci√≥n\n"
            "‚úÖ Mini-lecciones y bonus\n"
            "üí∂ Suscripci√≥n: solo 15 ‚Ç¨ al mes\n"
            "üì¶ Acceso al canal privado despu√©s del pago\n\n"
            "üöÄ ¬øListo para empezar? Botones abajo ‚¨áÔ∏è"
        )

    await callback.message.edit_text(greeting, reply_markup=main_keyboard(lang))
    await callback.answer()

@dp.callback_query_handler(lambda c: c.data == "faq")
async def send_faq(callback: CallbackQuery):
    uid = callback.from_user.id
    lang = user_data.get(uid, {}).get("lang", "ru")
    text = FAQ_RU if lang == "ru" else FAQ_ES
    await callback.message.answer(text, reply_markup=faq_keyboard(lang))
    await callback.answer()

# –§–æ—Ç–æ: OCR –æ—Ç–∫–ª—é—á–µ–Ω ‚Äî –¥–∞–µ–º –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
@dp.message_handler(content_types=[ContentType.PHOTO])
async def photo_stub(message: Message):
    lang = user_data.get(message.from_user.id, {}).get("lang", "ru")
    text = (
        "‚ÑπÔ∏è –°–µ–π—á–∞—Å –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤. –ù–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ –ø—Ä–∏—à–ª–∏ ID/–∫–≤–∏—Ç–∞–Ω—Ü–∏—é –ø–ª–∞—Ç–µ–∂–∞."
        if lang == "ru" else
        "‚ÑπÔ∏è El bot funciona sin OCR por ahora. Escribe a soporte o env√≠a el ID/recibo del pago."
    )
    await message.answer(text)

# ========= Entrypoint =========
if __name__ == "__main__":
    # –¢–æ–ª—å–∫–æ polling ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è Render Background Worker
    executor.start_polling(dp, skip_updates=True)
