import os
import asyncio
from datetime import datetime, timedelta
from typing import Dict

from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery, Message, ContentType

from PIL import Image
import pytesseract

# ----------------------
# Configuration
# ----------------------
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("Environment variable BOT_TOKEN is not set")

# Single PayPal URL used for both languages (replace with your own)
PAYPAL_URL = os.getenv("PAYPAL_URL", "https://www.paypal.com/qrcodes/p2pqr/3MVJCABCAVKN6")
SUPPORT_URL = os.getenv("SUPPORT_URL", "https://t.me/Linavibeart")

CHANNEL_LINKS: Dict[str, str] = {
    "ru": "https://t.me/+ebPVUZ8dzkwOWU8",  # RU channel invite link
    "es": "https://t.me/+HPXk4hRDxpMWpWQ0",  # ES channel invite link
}

# FAQ text (RU and ES). Keep it short enough for Telegram message limits.
FAQ_RU = (
    "üí¨ –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n"
    "1) ‚è≥ –°–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ—Å—Ç—É–ø?\n"
    "–ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 –º–µ—Å—è—Ü.\n\n"
    "2) üìö –ï—Å—Ç—å –ª–∏ –≤ –∫–∞–Ω–∞–ª–µ —É–∂–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã?\n"
    "–î–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã —É–∂–µ –µ—Å—Ç—å –∏ –ø–æ–ø–æ–ª–Ω—è—é—Ç—Å—è 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é.\n\n"
    "3) üõü –ï—Å—Ç—å –ª–∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞?\n"
    "–î–∞, 2 —Ä–∞–∑–∞ –≤ –º–µ—Å—è—Ü –æ—Ç–∫—Ä—ã–≤–∞—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤.\n\n"
    "4) üîí –ß—Ç–æ –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–¥–ª—é –≤–æ–≤—Ä–µ–º—è?\n"
    "–î–æ—Å—Ç—É–ø –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–∂–Ω–æ, –æ—Ñ–æ—Ä–º–∏–≤ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ.\n\n"
    "5) üí≥ –ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å/–ø—Ä–æ–¥–ª–∏—Ç—å?\n"
    "–ü–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.\n\n"
    "6) üí∏ –ú–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏?\n"
    "–í–æ–∑–≤—Ä–∞—Ç –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω, –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ.\n\n"
    "7) üßë‚Äçüéì –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–Ω–∞–ª –Ω–æ–≤–∏—á–∫–∞–º? ‚Äî –î–∞, –æ—Ç –Ω–æ–≤–∏—á–∫–æ–≤ –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö.\n\n"
    "8) ‚è±Ô∏è –ú–æ–∂–Ω–æ –ª–∏ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è? ‚Äî –î–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –∫–∞–Ω–∞–ª–µ.\n\n"
    "9) ‚ùó–ù–µ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã? ‚Äî –ù–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.\n\n"
    "‚ùì –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã? –ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ."
)

FAQ_ES = (
    "üí¨ Preguntas frecuentes\n\n"
    "1) ‚è≥ ¬øDuraci√≥n del acceso? ‚Äî 1 mes.\n\n"
    "2) üìö ¬øHay contenido ya? ‚Äî S√≠, y se actualiza 3 veces por semana.\n\n"
    "3) üõü ¬øHay soporte? ‚Äî S√≠, 2 veces al mes abro comentarios.\n\n"
    "4) üîí Si no renuevo a tiempo, el acceso se pausa hasta renovar.\n\n"
    "5) üí≥ ¬øC√≥mo pagar/renovar? ‚Äî Recibir√°s un aviso antes de que termine el per√≠odo.\n\n"
    "6) üí∏ ¬øReembolso? ‚Äî No, pero puedes cancelar la renovaci√≥n.\n\n"
    "7) üßë‚Äçüéì ¬øPara principiantes? ‚Äî S√≠, para todos los niveles.\n\n"
    "8) ‚è±Ô∏è ¬øVer cuando quieras? ‚Äî S√≠, el contenido permanece en el canal.\n\n"
    "9) ‚ùó¬øSin acceso tras pagar? ‚Äî Escribe a soporte.\n\n"
    "‚ùì ¬øM√°s preguntas? Pulsa los botones abajo."
)

# In‚Äëmemory user data (simple demo; replace with DB in production)
user_data: Dict[int, Dict] = {}

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

# ----------------------
# Keyboards
# ----------------------

def lang_keyboard() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang:ru"))
    kb.add(InlineKeyboardButton("üá™üá∏ Espa√±ol", callback_data="lang:es"))
    return kb


def main_keyboard(lang: str) -> InlineKeyboardMarkup:
    text_watch = "‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ" if lang == "ru" else "‚ñ∂Ô∏è Ver video"
    text_pay = "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal" if lang == "ru" else "üí≥ Pagar con PayPal"
    text_faq = "‚ùì –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?" if lang == "ru" else "‚ùì ¬øTienes preguntas?"

    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text_watch, url="https://example.com/your-private-video.mp4")],
        [InlineKeyboardButton(text_pay, url=PAYPAL_URL)],
        [InlineKeyboardButton(text_faq, callback_data="faq")],
    ])


def faq_keyboard(lang: str) -> InlineKeyboardMarkup:
    text_pay = "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal" if lang == "ru" else "üí≥ Pagar con PayPal"
    text_support = "üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞" if lang == "ru" else "üÜò Soporte"
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text_pay, url=PAYPAL_URL)],
        [InlineKeyboardButton(text_support, url=SUPPORT_URL)],
    ])

# ----------------------
# Handlers
# ----------------------

@dp.message_handler(commands=["start"]) 
async def cmd_start(message: Message):
    await message.answer(
        "–í—ã–±–µ—Ä–∏ —è–∑—ã–∫ / Elige el idioma:", reply_markup=lang_keyboard()
    )


@dp.callback_query_handler(lambda c: c.data and c.data.startswith("lang:"))
async def select_lang(callback: CallbackQuery):
    lang = callback.data.split(":", 1)[1]
    user_id = callback.from_user.id
    user_data[user_id] = user_data.get(user_id, {})
    user_data[user_id]["lang"] = lang

    if lang == "ru":
        greeting = (
            "üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –õ–∏–Ω—ã\n\n"
            "–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –∂–¥—ë—Ç:\n"
            "‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–∏–¥–µ–æ\n"
            "‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n"
            "‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Å—ä—ë–º–∫–µ –∏ —Å–≤–µ—Ç—É\n"
            "‚úÖ –ú–∏–Ω–∏‚Äë—É—Ä–æ–∫–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ ¬´–ø–ª—é—à–∫–∏¬ª\n"
            "üí∂ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –≤—Å–µ–≥–æ 15 –µ–≤—Ä–æ –≤ –º–µ—Å—è—Ü\n"
            "üì¶ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª —Å —É—Ä–æ–∫–∞–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏\n\n"
            "üöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ö–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ ‚¨áÔ∏è"
        )
    else:
        greeting = (
            "üëã ¬°Hola! Soy el asistente de Lina\n\n"
            "Dentro te espera:\n"
            "‚úÖ Contenido exclusivo\n"
            "‚úÖ An√°lisis detallado de videos\n"
            "‚úÖ Proyectos reales\n"
            "‚úÖ Consejos pr√°cticos sobre iluminaci√≥n\n"
            "‚úÖ Mini‚Äëlecciones y bonus\n"
            "üí∂ Suscripci√≥n: solo 15 ‚Ç¨ al mes\n"
            "üì¶ Acceso al canal privado despu√©s del pago\n\n"
            "üöÄ ¬øListo para empezar? Botones abajo ‚¨áÔ∏è"
        )

    await callback.message.edit_text(greeting, reply_markup=main_keyboard(lang))
    await callback.answer()


@dp.callback_query_handler(lambda c: c.data == "faq")
async def send_faq(callback: CallbackQuery):
    user_id = callback.from_user.id
    lang = user_data.get(user_id, {}).get("lang", "ru")
    text = FAQ_RU if lang == "ru" else FAQ_ES
    await callback.message.answer(text, reply_markup=faq_keyboard(lang))
    await callback.answer()


@dp.message_handler(content_types=ContentType.PHOTO)
async def check_payment_screenshot(message: Message):
    user_id = message.from_user.id
    lang = user_data.get(user_id, {}).get("lang", "ru")

    # Download the highest‚Äëresolution photo
    file = await bot.get_file(message.photo[-1].file_id)
    file_path = file.file_path

    # Save to a unique temp file
    timestamp = datetime.utcnow().strftime("%Y%m%d%H%M%S")
    tmp_path = f"screenshot_{user_id}_{timestamp}.jpg"
    await bot.download_file(file_path, tmp_path)

    try:
        text = pytesseract.image_to_string(Image.open(tmp_path))
    finally:
        # Clean up
        try:
            os.remove(tmp_path)
        except OSError:
            pass

    keywords = ["paypal", "15", "euro", "–µ–≤—Ä–æ", "—Å—É–º–º–∞", "–ø–ª–∞—Ç–µ–∂"]

    if any(k in text.lower() for k in keywords):
        # Mark subscription and send channel link
        user_data.setdefault(user_id, {})["subscribed"] = True
        user_data[user_id]["subscription_expires"] = datetime.utcnow() + timedelta(days=30)
        link = CHANNEL_LINKS.get(lang, list(CHANNEL_LINKS.values())[0])
        ok_text = (
            "‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–ª–∞—Ç—É!\n–í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª: " if lang == "ru" 
            else "‚úÖ ¬°Pago confirmado!\nEnlace al canal privado: "
        )
        await message.answer(ok_text + link)
    else:
        fail_text = (
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω—ã —Å—É–º–º–∞, –≤–∞–ª—é—Ç–∞ –∏ PayPal."
            if lang == "ru" else
            "‚ùå No se pudo confirmar el pago. Aseg√∫rate de que en la captura se vean claramente el importe, la moneda y PayPal."
        )
        await message.answer(fail_text)


# ----------------------
# Entrypoint
# ----------------------
if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
