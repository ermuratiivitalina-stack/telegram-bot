import os
import asyncio
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery, Message
from aiogram.utils import executor
import pytesseract
from PIL import Image

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("No BOT_TOKEN provided")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

user_data = {}

CHANNEL_LINKS = {
    "ru": "https://t.me/+bePV7UZ8zdwxOWU0",
    "es": "https://t.me/+HPXk4hRDxpMwYWQ0"
}

FAQ_TEXT = """üí¨ –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã
üìÖ 1. –°–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É?
–ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 –º–µ—Å—è—Ü, –ø–æ—Å–ª–µ —á–µ–≥–æ –µ—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–¥–ª–∏—Ç—å.
üìò 2. –ï—Å—Ç—å –ª–∏ –≤ –∫–∞–Ω–∞–ª–µ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã?
–î–∞! –í –∫–∞–Ω–∞–ª–µ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –æ–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –∏ –Ω–æ–≤—ã–µ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é.
üí¨ 3. –ï—Å—Ç—å –ª–∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞?
–î–∞, –¥–≤–∞–∂–¥—ã –≤ –º–µ—Å—è—Ü –õ–∏–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –≥–¥–µ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã.
üîí 4. –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —è –Ω–µ –ø—Ä–æ–¥–ª—é –ø–æ–¥–ø–∏—Å–∫—É –≤–æ–≤—Ä–µ–º—è?
–ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.
üí≥ 5. –ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–ø–ª–∞—Ç–∞ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏?
–ü–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å —á–µ—Ä–µ–∑ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–±.
üí∞ 6. –ú–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏?
–í–æ–∑–≤—Ä–∞—Ç –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω, –Ω–æ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ.
üéì 7. –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–Ω–∞–ª –Ω–æ–≤–∏—á–∫–∞–º?
–î–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π.
‚è∞ 8. –ú–æ–∂–Ω–æ –ª–∏ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è?
–î–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –∫–∞–Ω–∞–ª–µ.
üÜò 9. –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã?
–ù–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
üë©‚Äçüè´ 10. –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–¥–∞—Ç—å –ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –õ–∏–Ω–µ?
–î–∞, —á–µ—Ä–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–ª–∏ —ç—Ñ–∏—Ä—ã.
"""

@dp.message_handler(commands=["start"])
async def start_cmd(m: Message):
    keyboard = InlineKeyboardMarkup()
    keyboard.add(
        InlineKeyboardButton("–†—É—Å—Å–∫–∏–π üá∑üá∫", callback_data="lang_ru"),
        InlineKeyboardButton("Espa√±ol üá™üá∏", callback_data="lang_es")
    )
    await m.answer("–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Elige el idioma", reply_markup=keyboard)

@dp.callback_query_handler(lambda c: c.data.startswith("lang_"))
async def select_lang(callback: CallbackQuery):
    lang = callback.data.split("_")[1]
    user_id = callback.from_user.id
    user_data[user_id] = {"lang": lang}

    if lang == "ru":
        greeting = (
            "üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –õ–∏–Ω—ã üòä\n"
            "–†–∞–¥, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –≥–¥–µ —É—á–∞—Ç—Å—è —Å–Ω–∏–º–∞—Ç—å –≤–∏–¥–µ–æ –∏ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ —Ü–µ–ø–ª—è—é—Ç üé•‚ú®\n"
            "–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –∂–¥—ë—Ç:\n"
            "‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–∏–¥–µ–æ\n"
            "‚úÖ –ö—Ä—É–ø–Ω—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n"
            "‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Å—ä—ë–º–∫–µ –∏ —Å–≤–µ—Ç—É\n"
            "‚úÖ –ú–∏–Ω–∏-—É—Ä–æ–∫–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ ¬´–ø–ª—é—à–∫–∏¬ª\n"
            "‚úÖ –†–∞–∑–±–æ—Ä—ã –≤–∏–¥–µ–æ —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö\n"
            "üí∞ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –≤—Å–µ–≥–æ 15 –µ–≤—Ä–æ –≤ –º–µ—Å—è—Ü\n"
            "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª —Å —É—Ä–æ–∫–∞–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ üîí\n"
            "üöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ö–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ üëá"
        )
        buttons = [
            [InlineKeyboardButton("üé• –°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ", url="https://example.com/your-private-video.mp4")],
            [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal", url="https://www.paypal.com/qrcodes/p2pqrc/3MVJCABCAWXN6")],
            [InlineKeyboardButton("‚ùì –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?", callback_data="faq")]
        ]
    else:
        greeting = (
            "üëã ¬°Hola! Soy el asistente de Lina üòä\n"
            "Est√°s muy cerca de unirte a una comunidad privada donde aprender√°s a crear videos y fotos impactantes üé•‚ú®\n"
            "‚úÖ Contenido exclusivo\n"
            "‚úÖ An√°lisis detallado de videos\n"
            "‚úÖ Proyectos reales\n"
            "‚úÖ Consejos pr√°cticos sobre iluminaci√≥n\n"
            "‚úÖ Mini-lecciones y bonus\n"
            "üí∞ Suscripci√≥n: solo 15 ‚Ç¨ al mes\n"
            "üîí Accede al canal privado despu√©s del pago\n"
            "üöÄ ¬øListo para empezar? Pulsa los botones üëá"
        )
        buttons = [
            [InlineKeyboardButton("üé• Ver video", url="https://example.com/your-private-video.mp4")],
            [InlineKeyboardButton("üí≥ Pagar con PayPal", url="https://www.paypal.com/qrcodes/p2pqrc/3MVJCABCAWXN6")],
            [InlineKeyboardButton("‚ùì ¬øTienes preguntas?", callback_data="faq")]
        ]

    markup = InlineKeyboardMarkup(inline_keyboard=buttons)
    await callback.message.edit_text(greeting, reply_markup=markup)

@dp.callback_query_handler(lambda c: c.data == "faq")
async def send_faq(callback: CallbackQuery):
    await callback.message.answer(FAQ_TEXT)
    lang = user_data[callback.from_user.id]["lang"]
    buttons = [
        [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PayPal" if lang == "ru" else "üí≥ Pagar con PayPal", url="https://www.paypal.com/qrcodes/p2pqrc/3MVJCABCAWXN6")],
        [InlineKeyboardButton("üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url="https://t.me/Linavibeart")]
    ]
    await callback.message.answer("üëá", reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons))

@dp.message_handler(content_types=types.ContentType.PHOTO)
async def check_payment_screenshot(message: Message):
    user_id = message.from_user.id
    file = await bot.get_file(message.photo[-1].file_id)
    filepath = file.file_path
    saved_path = "screenshot_check.jpg"
    await bot.download_file(filepath, saved_path)

    text = pytesseract.image_to_string(Image.open(saved_path))
    os.remove(saved_path)

    keywords = ["paypal", "15", "eur", "–µ–≤—Ä–æ", "—Å—É–º–º–∞", "–ø–ª–∞—Ç–µ–∂"]
    if any(k.lower() in text.lower() for k in keywords):
        user_data[user_id]["subscribed"] = True
        user_data[user_id]["subscription_expires"] = datetime.utcnow() + timedelta(days=30)
        lang = user_data[user_id]["lang"]
        await message.answer(f"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–ª–∞—Ç—É!\n–í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª: {CHANNEL_LINKS[lang]}")
    else:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç —á—ë—Ç–∫–∏–π –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª–∏ –æ–ø–ª–∞—Ç—ã.")

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
