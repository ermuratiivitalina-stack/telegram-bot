import os
import logging
import asyncio
from datetime import datetime
import pytesseract
from PIL import Image
import io
import aiosqlite
from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor

logging.basicConfig(level=logging.INFO)

BOT_TOKEN = os.getenv('BOT_TOKEN')
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN not provided")

CHANNEL_ID = os.getenv('CHANNEL_ID')
CHANNEL_LINK = "https://t.me/+bePV7UZ8zdwxOWU0"
PAYPAL_LINK = "https://www.paypal.com/qrcodes/p2pqrc/3MVJCABCAWXN6"
SUPPORT_LINK = "https://t.me/Linavibeart"

# Note: Set CHANNEL_ID (channel username or ID) in environment for membership checking.
if CHANNEL_ID:
    CHANNEL_ID = CHANNEL_ID.strip()
    if CHANNEL_ID.lstrip('-').isdigit():
        CHANNEL_ID = int(CHANNEL_ID)

DB_PATH = os.getenv('DB_PATH', 'database.db')

START_TEXT = "Choose language / Elige el idioma"
LANG_BUTTON_RU = "–†—É—Å—Å–∫–∏–π üá∑üá∫"
LANG_BUTTON_ES = "Espa√±ol üá™üá∏"

TEXT_SUBSCRIBE_PROMPT = {
    'ru': f"–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª: {CHANNEL_LINK}\n–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.",
    'es': f"Para continuar, por favor suscr√≠bete a nuestro canal: {CHANNEL_LINK}\nDespu√©s de eso, haz clic en el bot√≥n de abajo para verificar tu suscripci√≥n."
}
TEXT_NOT_SUBSCRIBED = {
    'ru': "–í—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
    'es': "A√∫n no te has suscrito al canal. Por favor, suscr√≠bete y vuelve a intentarlo."
}
TEXT_PAYMENT_INSTRUCTIONS = {
    'ru': "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –æ–ø–ª–∞—Ç–∏—Ç–µ 15‚Ç¨ —á–µ—Ä–µ–∑ PayPal –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.",
    'es': "¬°Excelente! Ahora paga 15‚Ç¨ a trav√©s de PayPal usando el enlace a continuaci√≥n. Despu√©s del pago, env√≠a una captura de pantalla de la confirmaci√≥n para activar tu suscripci√≥n."
}
TEXT_SUBSCRIPTION_CONFIRMED = {
    'ru': "‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ {date}.",
    'es': "‚úÖ Su suscripci√≥n est√° activa hasta el {date}."
}
TEXT_PAYMENT_NOT_RECOGNIZED = {
    'ru': "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.",
    'es': "‚ùå No se pudo verificar el pago. Por favor, aseg√∫rate de enviar la captura de pantalla correcta. Si el error persiste, contacta al soporte."
}
FAQ_RU = """–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã:

1. –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É?
–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

2. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π?
–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É, –æ–ø–ª–∞—Ç–∏–≤ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ä–æ–∫–∞.

–ï—Å–ª–∏ —É –≤–∞—Å –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."""
FAQ_ES = """Preguntas frecuentes:

1. ¬øC√≥mo obtengo acceso al contenido?
Despu√©s de activar la suscripci√≥n, el acceso se otorgar√° autom√°ticamente.

2. ¬øQu√© sucede despu√©s de 30 d√≠as?
Puedes extender la suscripci√≥n pagando el pr√≥ximo mes antes de que termine el per√≠odo actual.

Si tienes m√°s preguntas, por favor contacta al soporte."""
FAQ_TEXT = {
    'ru': FAQ_RU,
    'es': FAQ_ES
}
BUTTON_CHECK_SUB = {
    'ru': "‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É",
    'es': "‚úÖ Verificar suscripci√≥n"
}
BUTTON_PAY = {
    'ru': "–û–ø–ª–∞—Ç–∏—Ç—å üí≥",
    'es': "Pagar üí≥"
}
BUTTON_QUESTIONS = {
    'ru': "–û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?",
    'es': "¬øPreguntas?"
}
BUTTON_SUPPORT = {
    'ru': "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ üì®",
    'es': "Soporte üì®"
}

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

async def on_startup(dispatcher):
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("""
            CREATE TABLE IF NOT EXISTS subscriptions (
                user_id INTEGER PRIMARY KEY,
                language TEXT,
                is_active INTEGER,
                end_date INTEGER
            )
        """)
        await db.commit()

@dp.message_handler(commands=['start'])
async def cmd_start(message: types.Message):
    keyboard = types.InlineKeyboardMarkup(row_width=2)
    keyboard.add(types.InlineKeyboardButton(LANG_BUTTON_RU, callback_data='lang_ru'),
                 types.InlineKeyboardButton(LANG_BUTTON_ES, callback_data='lang_es'))
    await message.answer(START_TEXT, reply_markup=keyboard)

@dp.callback_query_handler(lambda c: c.data in ['lang_ru', 'lang_es'])
async def callback_language(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    lang = 'ru' if callback_query.data == 'lang_ru' else 'es'
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("INSERT OR IGNORE INTO subscriptions (user_id, language, is_active, end_date) VALUES (?, ?, 0, 0)", (user_id, lang))
        await db.execute("UPDATE subscriptions SET language=? WHERE user_id=?", (lang, user_id))
        await db.commit()
    await callback_query.answer()
    try:
        await callback_query.message.edit_reply_markup(reply_markup=None)
    except Exception as e:
        logging.warning(f"Failed to edit message markup: {e}")
    text = TEXT_SUBSCRIBE_PROMPT.get(lang, TEXT_SUBSCRIBE_PROMPT['ru'])
    keyboard = types.InlineKeyboardMarkup()
    keyboard.add(types.InlineKeyboardButton(BUTTON_CHECK_SUB.get(lang, "‚úÖ Verify"), callback_data='check_sub'))
    await bot.send_message(callback_query.from_user.id, text, reply_markup=keyboard)

@dp.callback_query_handler(lambda c: c.data == 'check_sub')
async def callback_check_sub(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    lang = 'ru'
    async with aiosqlite.connect(DB_PATH) as db:
        result = await db.execute("SELECT language FROM subscriptions WHERE user_id=?", (user_id,))
        row = await result.fetchone()
        if row:
            lang = row[0] or 'ru'
    try:
        member = await bot.get_chat_member(CHANNEL_ID if CHANNEL_ID else CHANNEL_LINK, user_id)
        status = member.status
    except Exception as e:
        logging.error(f"Error checking channel membership for user {user_id}: {e}")
        error_msg = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ." if lang == 'ru' else ("No se pudo verificar la suscripci√≥n. Int√©ntalo m√°s tarde." if lang == 'es' else "Can't verify subscription now.")
        await callback_query.answer(error_msg, show_alert=True)
        return
    if status in ['member', 'administrator', 'creator']:
        await callback_query.answer()
        try:
            await callback_query.message.edit_reply_markup(reply_markup=None)
        except Exception as e:
            logging.warning(f"Failed to edit message markup: {e}")
        text = TEXT_PAYMENT_INSTRUCTIONS.get(lang, TEXT_PAYMENT_INSTRUCTIONS['ru'])
        keyboard = types.InlineKeyboardMarkup(row_width=2)
        keyboard.add(types.InlineKeyboardButton(BUTTON_PAY.get(lang, "Pay üí≥"), url=PAYPAL_LINK),
                     types.InlineKeyboardButton(BUTTON_QUESTIONS.get(lang, "FAQ"), callback_data='faq'))
        await bot.send_message(callback_query.from_user.id, text, reply_markup=keyboard)
    else:
        msg = TEXT_NOT_SUBSCRIBED.get(lang, TEXT_NOT_SUBSCRIBED['ru'])
        await callback_query.answer(msg, show_alert=True)

@dp.callback_query_handler(lambda c: c.data == 'faq')
async def callback_faq(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    lang = 'ru'
    async with aiosqlite.connect(DB_PATH) as db:
        result = await db.execute("SELECT language FROM subscriptions WHERE user_id=?", (user_id,))
        row = await result.fetchone()
        if row:
            lang = row[0] or 'ru'
    text = FAQ_TEXT.get(lang, FAQ_TEXT['ru'])
    keyboard = types.InlineKeyboardMarkup(row_width=2)
    keyboard.add(types.InlineKeyboardButton(BUTTON_PAY.get(lang, "Pay üí≥"), url=PAYPAL_LINK),
                 types.InlineKeyboardButton(BUTTON_SUPPORT.get(lang, "Support üì®"), url=SUPPORT_LINK))
    await callback_query.answer()
    await bot.send_message(callback_query.from_user.id, text, reply_markup=keyboard)

@dp.message_handler(content_types=['photo', 'document'])
async def handle_screenshot(message: types.Message):
    user_id = message.from_user.id
    lang = 'ru'
    prev_end = 0
    async with aiosqlite.connect(DB_PATH) as db:
        result = await db.execute("SELECT language, end_date FROM subscriptions WHERE user_id=?", (user_id,))
        row = await result.fetchone()
        if row:
            lang = row[0] or 'ru'
            prev_end = row[1] or 0
    image_bytes = None
    if message.photo:
        photo = message.photo[-1]
        b = io.BytesIO()
        await photo.download(destination_file=b)
        image_bytes = b.getvalue()
    elif message.document:
        if message.document.mime_type and message.document.mime_type.startswith('image'):
            b = io.BytesIO()
            await message.document.download(destination_file=b)
            image_bytes = b.getvalue()
        else:
            response = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ." if lang == 'ru' else "Por favor env√≠a la captura de pantalla como una imagen."
            await message.reply(response)
            return
    if not image_bytes:
        return
    try:
        image = Image.open(io.BytesIO(image_bytes))
    except Exception as e:
        logging.error(f"Failed to open image: {e}")
        error_text = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑." if lang == 'ru' else "No se pudo procesar la imagen. Int√©ntalo de nuevo."
        await message.reply(error_text)
        return
    loop = asyncio.get_running_loop()
    try:
        text = await loop.run_in_executor(None, pytesseract.image_to_string, image)
    except Exception as e:
        logging.error(f"OCR error: {e}")
        error_text = "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É." if lang == 'ru' else "No se pudo reconocer texto en la imagen. Int√©ntalo de nuevo o contacta al soporte."
        await message.reply(error_text)
        image.close()
        return
    finally:
        image.close()
    text_lower = text.lower()
    keywords = ["paypal", "15", "eur", "‚Ç¨", "–µ–≤—Ä–æ", "–æ–ø–ª–∞—Ç", "pago"]
    confirmed = any(kw in text_lower for kw in keywords)
    if confirmed:
        now_ts = int(datetime.now().timestamp())
        new_end = now_ts + 30*24*60*60
        if prev_end and now_ts < prev_end:
            new_end = prev_end + 30*24*60*60
        async with aiosqlite.connect(DB_PATH) as db:
            await db.execute("INSERT OR IGNORE INTO subscriptions (user_id, language, is_active, end_date) VALUES (?, ?, 1, ?)", (user_id, lang, new_end))
            await db.execute("UPDATE subscriptions SET is_active=1, end_date=?, language=? WHERE user_id=?", (new_end, lang, user_id))
            await db.commit()
        end_date_dt = datetime.fromtimestamp(new_end)
        date_str = end_date_dt.strftime("%d.%m.%Y") if lang == 'ru' else end_date_dt.strftime("%d/%m/%Y")
        text_confirm = TEXT_SUBSCRIPTION_CONFIRMED.get(lang, TEXT_SUBSCRIPTION_CONFIRMED['ru']).format(date=date_str)
        await message.reply(text_confirm)
    else:
        text_fail = TEXT_PAYMENT_NOT_RECOGNIZED.get(lang, TEXT_PAYMENT_NOT_RECOGNIZED['ru'])
        await message.reply(text_fail)

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True, on_startup=on_startup)
