import os
import asyncio
import threading
from http.server import BaseHTTPRequestHandler, HTTPServer
from aiogram import Bot, Dispatcher, F
from aiogram.filters import Command
from aiogram.types import (
    Message,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    ChatJoinRequest,
)

# --- CONFIG ---
BOT_TOKEN = os.getenv("BOT_TOKEN")
RU_CHAT_ID = int(os.getenv("RU_CHAT_ID", "0"))
ES_CHAT_ID = int(os.getenv("ES_CHAT_ID", "0"))

bot = Bot(BOT_TOKEN)
dp = Dispatcher()

# --- UI Keyboards ---
def lang_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="Russian üá∑üá∫", callback_data="lang_ru")],
        [InlineKeyboardButton(text="Espa√±ol üá™üá∏", callback_data="lang_es")]
    ])

def payment_keyboard(lang):
    if lang == "ru":
        return InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="–û–ø–ª–∞—Ç–∏—Ç—å (PayPal)", url="https://paypal.me/yourlink")],
            [InlineKeyboardButton(text="–û–ø–ª–∞—Ç–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É üí≥", url="https://yourbanklink.com")],
            [InlineKeyboardButton(text="–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ", callback_data="more_ru")]
        ])
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="Pagar (PayPal)", url="https://paypal.me/yourlink")],
        [InlineKeyboardButton(text="Pagar con tarjeta üí≥", url="https://yourbanklink.com")],
        [InlineKeyboardButton(text="Saber m√°s", callback_data="more_es")]
    ])

# --- Handlers ---
@dp.message(Command("start"))
async def start_cmd(m: Message):
    await m.answer("Choose language / Elige el idioma", reply_markup=lang_keyboard())

@dp.callback_query(F.data.startswith("lang_"))
async def select_lang(cq):
    lang = cq.data.split("_")[1]
    text = {
        "ru": (
            "\U0001F44B –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –õ–∏–Ω—ã \U0001F60A\n"
            "–†–∞–¥, —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –≥–¥–µ —É—á–∞—Ç—Å—è —Å–Ω–∏–º–∞—Ç—å –≤–∏–¥–µ–æ –∏ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ —Ü–µ–ø–ª—è—é—Ç \U0001F3A5‚ú®\n\n"
            "–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –∂–¥—ë—Ç:\n"
            "‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–∏–¥–µ–æ\n"
            "‚úÖ –ö—Ä—É–ø–Ω—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n"
            "‚úÖ –°–æ–≤–µ—Ç—ã –ø–æ —Å—ä—ë–º–∫–µ –∏ —Å–≤–µ—Ç—É\n"
            "‚úÖ –ú–∏–Ω–∏-—É—Ä–æ–∫–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –ø–ª—é—à–∫–∏\n"
            "‚úÖ –í–∏–¥–µ–æ –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –¥–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö\n\n"
            "üí∞ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –≤—Å–µ–≥–æ 15 –µ–≤—Ä–æ –≤ –º–µ—Å—è—Ü\n"
            "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—à—å –¥–æ—Å—Ç—É–ø –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª üîí\n\n"
            "üöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? –ö–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ üëá"
        ),
        "es": (
            "\U0001F44B ¬°Hola! Soy el asistente de Lina üòä\n"
            "Ya casi est√°s dentro de la comunidad secreta para aprender a crear fotos y videos que impactan üé•‚ú®\n\n"
            "Dentro encontrar√°s:\n"
            "‚úÖ An√°lisis detallados\n"
            "‚úÖ Proyectos reales\n"
            "‚úÖ Consejos sobre grabaci√≥n y luz\n"
            "‚úÖ Mini lecciones y trucos\n"
            "‚úÖ Videos para todos los niveles\n\n"
            "üí∞ Suscripci√≥n: solo 15 euros/mes\n"
            "Acceso inmediato al canal cerrado tras el pago üîí\n\n"
            "üöÄ ¬øListo para empezar? üëá"
        )
    }
    await cq.message.answer(text[lang], reply_markup=payment_keyboard(lang))
    await cq.answer()

@dp.callback_query(F.data.startswith("more_"))
async def send_more(cq):
    lang = cq.data.split("_")[1]
    video_url = "https://example.com/your-private-video.mp4"  # Replace with actual
    chat_link = "https://t.me/Linavibeart"
    if lang == "ru":
        markup = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="–û–ø–ª–∞—Ç–∏—Ç—å", url="https://paypal.me/yourlink")],
            [InlineKeyboardButton(text="–û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?", url=chat_link)]
        ])
        await cq.message.answer(f"–í–∏–¥–µ–æ –æ –∑–∞–∫—Ä—ã—Ç–æ–º –∫–∞–Ω–∞–ª–µ: {video_url}", reply_markup=markup)
    else:
        markup = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="Pagar", url="https://paypal.me/yourlink")],
            [InlineKeyboardButton(text="¬øDudas?", url=chat_link)]
        ])
        await cq.message.answer(f"Video del canal privado: {video_url}", reply_markup=markup)
    await cq.answer()

@dp.chat_join_request()
async def approve_user(r: ChatJoinRequest):
    try:
        await r.approve()
        await bot.send_message(r.from_user.id, "‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!")
        # TODO: Store user + datetime, then check after 30 days
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞:", e)

# --- Keep-alive for Render ---
class _HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == "/health":
            self.send_response(200)
            self.send_header("Content-Type", "text/plain")
            self.end_headers()
            self.wfile.write(b"OK")
        else:
            self.send_response(404)
            self.end_headers()

def _run_health_server():
    port = int(os.getenv("PORT", "8080"))
    server = HTTPServer(("0.0.0.0", port), _HealthHandler)
    server.serve_forever()

threading.Thread(target=_run_health_server, daemon=True).start()

# --- Start ---
async def main():
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
